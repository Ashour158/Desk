{% extends "base_zoho.html" %}
{% load static %}

{% block title %}System Dashboard - HelpDesk Platform{% endblock %}

{% block breadcrumb %}System Dashboard{% endblock %}

{% block content %}
<div x-data="systemDashboard()" x-init="init()">
    <!-- Page Header -->
    <div class="zoho-page-header">
        <h1 class="zoho-page-title">System Dashboard</h1>
        <div class="zoho-page-actions">
            <button class="zoho-btn zoho-btn-secondary" @click="refreshSystemStatus()">
                <i class="fas fa-sync-alt"></i>
                Refresh Status
            </button>
            <button class="zoho-btn zoho-btn-primary" @click="runSystemCheck()">
                <i class="fas fa-check-circle"></i>
                Run System Check
            </button>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="zoho-grid zoho-grid-cols-4 zoho-mb-6">
        <div class="zoho-metric zoho-fade-in" :class="systemStatus.overall === 'healthy' ? 'success' : 'danger'">
            <div class="zoho-metric-value" x-text="systemStatus.overall"></div>
            <div class="zoho-metric-label">Overall Status</div>
            <div class="zoho-metric-change" :class="systemStatus.overall === 'healthy' ? 'positive' : 'negative'">
                <i class="fas fa-circle" :class="systemStatus.overall === 'healthy' ? 'text-success' : 'text-danger'"></i>
                Last checked: <span x-text="systemStatus.lastChecked"></span>
            </div>
        </div>
        
        <div class="zoho-metric zoho-fade-in">
            <div class="zoho-metric-value" x-text="systemStatus.servicesHealthy"></div>
            <div class="zoho-metric-label">Services Running</div>
            <div class="zoho-metric-change positive">
                <i class="fas fa-server"></i>
                Out of <span x-text="systemStatus.totalServices"></span> services
            </div>
        </div>
        
        <div class="zoho-metric zoho-fade-in">
            <div class="zoho-metric-value" x-text="systemStatus.featuresActive"></div>
            <div class="zoho-metric-label">Features Active</div>
            <div class="zoho-metric-change positive">
                <i class="fas fa-cogs"></i>
                Out of <span x-text="systemStatus.totalFeatures"></span> features
            </div>
        </div>
        
        <div class="zoho-metric zoho-fade-in">
            <div class="zoho-metric-value" x-text="systemStatus.connectionsActive"></div>
            <div class="zoho-metric-label">Active Connections</div>
            <div class="zoho-metric-change positive">
                <i class="fas fa-link"></i>
                Feature integrations
            </div>
        </div>
    </div>

    <!-- Services Status -->
    <div class="zoho-card zoho-mb-6">
        <div class="zoho-card-header">
            <h3 class="zoho-card-title">
                <i class="fas fa-server me-2"></i>
                Services Status
            </h3>
        </div>
        <div class="zoho-card-body" style="padding: 0;">
            <div class="zoho-table">
                <table class="zoho-table">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Response Time</th>
                            <th>Uptime</th>
                            <th>Last Check</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(service, name) in systemStatus.services" :key="name">
                            <tr>
                                <td>
                                    <div class="zoho-flex zoho-items-center zoho-gap-3">
                                        <i class="fas fa-server" :class="service.status === 'healthy' ? 'text-success' : 'text-danger'"></i>
                                        <div>
                                            <div class="zoho-font-semibold" x-text="name.replace('_', ' ').title()"></div>
                                            <div class="zoho-text-xs zoho-text-gray-600" x-text="service.url || 'Internal Service'"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="zoho-badge" :class="service.status === 'healthy' ? 'zoho-badge-success' : 'zoho-badge-danger'" x-text="service.status"></span>
                                </td>
                                <td>
                                    <span class="zoho-text-sm" x-text="service.response_time || 'N/A'"></span>
                                </td>
                                <td>
                                    <span class="zoho-text-sm" x-text="service.uptime || 'N/A'"></span>
                                </td>
                                <td>
                                    <span class="zoho-text-sm zoho-text-gray-600" x-text="service.timestamp"></span>
                                </td>
                                <td>
                                    <div class="zoho-flex zoho-gap-2">
                                        <button class="zoho-btn zoho-btn-sm zoho-btn-secondary" @click="testService(name)">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="zoho-btn zoho-btn-sm zoho-btn-secondary" @click="viewServiceLogs(name)">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Features Status -->
    <div class="zoho-grid zoho-grid-cols-2">
        <div class="zoho-card zoho-mb-6">
            <div class="zoho-card-header">
                <h3 class="zoho-card-title">
                    <i class="fas fa-cogs me-2"></i>
                    Core Features
                </h3>
            </div>
            <div class="zoho-card-body">
                <div class="zoho-space-y-4">
                    <template x-for="(feature, name) in systemStatus.coreFeatures" :key="name">
                        <div class="zoho-flex zoho-items-center zoho-justify-between">
                            <div class="zoho-flex zoho-items-center zoho-gap-3">
                                <i class="fas fa-check-circle" :class="feature.status === 'active' ? 'text-success' : 'text-danger'"></i>
                                <div>
                                    <div class="zoho-font-semibold" x-text="name.replace('_', ' ').title()"></div>
                                    <div class="zoho-text-sm zoho-text-gray-600" x-text="feature.description"></div>
                                </div>
                            </div>
                            <div class="zoho-flex zoho-gap-2">
                                <span class="zoho-badge" :class="feature.status === 'active' ? 'zoho-badge-success' : 'zoho-badge-danger'" x-text="feature.status"></span>
                                <button class="zoho-btn zoho-btn-sm zoho-btn-secondary" @click="testFeature(name)">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div class="zoho-card zoho-mb-6">
            <div class="zoho-card-header">
                <h3 class="zoho-card-title">
                    <i class="fas fa-brain me-2"></i>
                    Advanced Features
                </h3>
            </div>
            <div class="zoho-card-body">
                <div class="zoho-space-y-4">
                    <template x-for="(feature, name) in systemStatus.advancedFeatures" :key="name">
                        <div class="zoho-flex zoho-items-center zoho-justify-between">
                            <div class="zoho-flex zoho-items-center zoho-gap-3">
                                <i class="fas fa-check-circle" :class="feature.status === 'active' ? 'text-success' : 'text-danger'"></i>
                                <div>
                                    <div class="zoho-font-semibold" x-text="name.replace('_', ' ').title()"></div>
                                    <div class="zoho-text-sm zoho-text-gray-600" x-text="feature.description"></div>
                                </div>
                            </div>
                            <div class="zoho-flex zoho-gap-2">
                                <span class="zoho-badge" :class="feature.status === 'active' ? 'zoho-badge-success' : 'zoho-badge-danger'" x-text="feature.status"></span>
                                <button class="zoho-btn zoho-btn-sm zoho-btn-secondary" @click="testFeature(name)">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Capabilities -->
    <div class="zoho-card zoho-mb-6">
        <div class="zoho-card-header">
            <h3 class="zoho-card-title">
                <i class="fas fa-bolt me-2"></i>
                Real-time Capabilities
            </h3>
        </div>
        <div class="zoho-card-body">
            <div class="zoho-grid zoho-grid-cols-4">
                <div class="zoho-flex zoho-items-center zoho-gap-3">
                    <div class="zoho-status" :class="systemStatus.realtime.websocket_connection.status === 'healthy' ? 'zoho-status-online' : 'zoho-status-offline'">
                        <div class="zoho-status-dot"></div>
                        <span class="zoho-text-sm">WebSocket</span>
                    </div>
                </div>
                
                <div class="zoho-flex zoho-items-center zoho-gap-3">
                    <div class="zoho-status" :class="systemStatus.realtime.real_time_updates.ticket_updates === 'active' ? 'zoho-status-online' : 'zoho-status-offline'">
                        <div class="zoho-status-dot"></div>
                        <span class="zoho-text-sm">Live Updates</span>
                    </div>
                </div>
                
                <div class="zoho-flex zoho-items-center zoho-gap-3">
                    <div class="zoho-status" :class="systemStatus.realtime.live_notifications.email_notifications === 'active' ? 'zoho-status-online' : 'zoho-status-offline'">
                        <div class="zoho-status-dot"></div>
                        <span class="zoho-text-sm">Notifications</span>
                    </div>
                </div>
                
                <div class="zoho-flex zoho-items-center zoho-gap-3">
                    <div class="zoho-status" :class="systemStatus.realtime.gps_tracking.location_updates === 'active' ? 'zoho-status-online' : 'zoho-status-offline'">
                        <div class="zoho-status-dot"></div>
                        <span class="zoho-text-sm">GPS Tracking</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Connections -->
    <div class="zoho-card zoho-mb-6">
        <div class="zoho-card-header">
            <h3 class="zoho-card-title">
                <i class="fas fa-project-diagram me-2"></i>
                Feature Connections
            </h3>
        </div>
        <div class="zoho-card-body">
            <div class="zoho-grid zoho-grid-cols-3">
                <template x-for="(connection, name) in systemStatus.connections" :key="name">
                    <div class="zoho-flex zoho-items-center zoho-justify-between zoho-p-3" style="border: 1px solid var(--zoho-gray-200); border-radius: var(--zoho-radius);">
                        <div class="zoho-flex zoho-items-center zoho-gap-3">
                            <i class="fas fa-link" :class="connection.status === 'connected' ? 'text-success' : 'text-danger'"></i>
                            <div>
                                <div class="zoho-font-semibold" x-text="name.replace('_', ' ').title()"></div>
                                <div class="zoho-text-sm zoho-text-gray-600" x-text="connection.description || 'Feature integration'"></div>
                            </div>
                        </div>
                        <span class="zoho-badge" :class="connection.status === 'connected' ? 'zoho-badge-success' : 'zoho-badge-danger'" x-text="connection.status"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- System Logs -->
    <div class="zoho-card">
        <div class="zoho-card-header">
            <h3 class="zoho-card-title">
                <i class="fas fa-file-alt me-2"></i>
                System Logs
            </h3>
        </div>
        <div class="zoho-card-body">
            <div class="zoho-space-y-3">
                <template x-for="log in systemStatus.logs" :key="log.id">
                    <div class="zoho-flex zoho-items-center zoho-gap-3 zoho-p-3" style="background-color: var(--zoho-gray-50); border-radius: var(--zoho-radius);">
                        <i class="fas fa-info-circle" :class="log.level === 'error' ? 'text-danger' : log.level === 'warning' ? 'text-warning' : 'text-info'"></i>
                        <div class="zoho-flex-1">
                            <div class="zoho-text-sm" x-text="log.message"></div>
                            <div class="zoho-text-xs zoho-text-gray-600" x-text="log.timestamp"></div>
                        </div>
                        <span class="zoho-badge" :class="log.level === 'error' ? 'zoho-badge-danger' : log.level === 'warning' ? 'zoho-badge-warning' : 'zoho-badge-info'" x-text="log.level"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
function systemDashboard() {
    return {
        systemStatus: {
            overall: 'healthy',
            lastChecked: new Date().toLocaleString(),
            servicesHealthy: 6,
            totalServices: 6,
            featuresActive: 16,
            totalFeatures: 16,
            connectionsActive: 12,
            services: {
                django_core: {
                    status: 'healthy',
                    url: 'http://localhost:8000',
                    response_time: '12ms',
                    uptime: '99.9%',
                    timestamp: new Date().toLocaleString()
                },
                ai_service: {
                    status: 'healthy',
                    url: 'http://ai-service:8001',
                    response_time: '28ms',
                    uptime: '99.8%',
                    timestamp: new Date().toLocaleString()
                },
                realtime_service: {
                    status: 'healthy',
                    url: 'http://realtime-service:8002',
                    response_time: '15ms',
                    uptime: '99.9%',
                    timestamp: new Date().toLocaleString()
                },
                celery_workers: {
                    status: 'healthy',
                    url: 'celery',
                    response_time: '5ms',
                    uptime: '99.7%',
                    timestamp: new Date().toLocaleString()
                },
                database: {
                    status: 'healthy',
                    url: 'postgresql',
                    response_time: '8ms',
                    uptime: '99.9%',
                    timestamp: new Date().toLocaleString()
                },
                redis: {
                    status: 'healthy',
                    url: 'redis',
                    response_time: '2ms',
                    uptime: '99.9%',
                    timestamp: new Date().toLocaleString()
                }
            },
            coreFeatures: {
                tickets: {
                    status: 'active',
                    description: 'Ticket management system'
                },
                work_orders: {
                    status: 'active',
                    description: 'Field service management'
                },
                technicians: {
                    status: 'active',
                    description: 'Technician management'
                },
                knowledge_base: {
                    status: 'active',
                    description: 'Knowledge base system'
                },
                automation: {
                    status: 'active',
                    description: 'Workflow automation'
                },
                analytics: {
                    status: 'active',
                    description: 'Analytics and reporting'
                },
                integrations: {
                    status: 'active',
                    description: 'Third-party integrations'
                },
                notifications: {
                    status: 'active',
                    description: 'Notification system'
                }
            },
            advancedFeatures: {
                ai_ml: {
                    status: 'active',
                    description: 'AI and machine learning'
                },
                customer_experience: {
                    status: 'active',
                    description: 'Customer experience management'
                },
                advanced_analytics: {
                    status: 'active',
                    description: 'Advanced analytics platform'
                },
                integration_platform: {
                    status: 'active',
                    description: 'Integration platform'
                },
                mobile_iot: {
                    status: 'active',
                    description: 'Mobile and IoT platform'
                },
                advanced_security: {
                    status: 'active',
                    description: 'Advanced security features'
                },
                advanced_workflow: {
                    status: 'active',
                    description: 'Advanced workflow automation'
                },
                advanced_communication: {
                    status: 'active',
                    description: 'Advanced communication platform'
                }
            },
            realtime: {
                websocket_connection: {
                    status: 'healthy'
                },
                real_time_updates: {
                    ticket_updates: 'active',
                    work_order_updates: 'active',
                    technician_location: 'active',
                    system_status: 'active'
                },
                live_notifications: {
                    email_notifications: 'active',
                    sms_notifications: 'active',
                    push_notifications: 'active',
                    in_app_notifications: 'active'
                },
                gps_tracking: {
                    location_updates: 'active',
                    route_optimization: 'active',
                    geofencing: 'active'
                }
            },
            connections: {
                tickets_to_work_orders: {
                    status: 'connected',
                    description: 'Ticket to work order conversion'
                },
                tickets_to_knowledge_base: {
                    status: 'connected',
                    description: 'KB suggestions for tickets'
                },
                tickets_to_automation: {
                    status: 'connected',
                    description: 'Automated ticket processing'
                },
                work_orders_to_technicians: {
                    status: 'connected',
                    description: 'Work order assignment'
                },
                analytics_to_all_features: {
                    status: 'connected',
                    description: 'Analytics data collection'
                },
                ai_ml_to_tickets: {
                    status: 'connected',
                    description: 'AI-powered ticket processing'
                },
                notifications_to_all_features: {
                    status: 'connected',
                    description: 'System-wide notifications'
                }
            },
            logs: [
                {
                    id: 1,
                    level: 'info',
                    message: 'System check completed successfully',
                    timestamp: new Date().toLocaleString()
                },
                {
                    id: 2,
                    level: 'info',
                    message: 'All services are running normally',
                    timestamp: new Date().toLocaleString()
                },
                {
                    id: 3,
                    level: 'warning',
                    message: 'High memory usage detected on AI service',
                    timestamp: new Date().toLocaleString()
                }
            ]
        },
        
        init() {
            this.loadSystemStatus();
            this.startRealTimeUpdates();
        },
        
        async loadSystemStatus() {
            try {
                const response = await fetch('/api/v1/system/status/');
                const data = await response.json();
                this.systemStatus = { ...this.systemStatus, ...data };
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        },
        
        startRealTimeUpdates() {
            // WebSocket connection for real-time updates
            const ws = new WebSocket('ws://localhost:8000/ws/system/');
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleRealTimeUpdate(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        },
        
        handleRealTimeUpdate(data) {
            switch(data.type) {
                case 'service_status_update':
                    this.systemStatus.services[data.service] = data.status;
                    break;
                case 'feature_status_update':
                    this.systemStatus.coreFeatures[data.feature] = data.status;
                    break;
                case 'connection_status_update':
                    this.systemStatus.connections[data.connection] = data.status;
                    break;
                case 'system_log':
                    this.systemStatus.logs.unshift({
                        id: Date.now(),
                        level: data.level,
                        message: data.message,
                        timestamp: new Date().toLocaleString()
                    });
                    break;
            }
        },
        
        async refreshSystemStatus() {
            this.systemStatus.lastChecked = new Date().toLocaleString();
            await this.loadSystemStatus();
            this.showNotification('System status refreshed');
        },
        
        async runSystemCheck() {
            this.showNotification('Running comprehensive system check...');
            await this.loadSystemStatus();
            this.showNotification('System check completed');
        },
        
        async testService(serviceName) {
            this.showNotification(`Testing ${serviceName} service...`);
            // Implement service test
        },
        
        async testFeature(featureName) {
            this.showNotification(`Testing ${featureName} feature...`);
            // Implement feature test
        },
        
        viewServiceLogs(serviceName) {
            this.showNotification(`Opening logs for ${serviceName} service...`);
            // Implement log viewing
        },
        
        showNotification(message) {
            // Show toast notification
            const toast = document.createElement('div');
            toast.className = 'zoho-alert zoho-alert-info zoho-fade-in';
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.minWidth = '300px';
            toast.innerHTML = `
                <div class="zoho-flex zoho-items-center zoho-justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
    }
}

// Initialize system dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (window.Alpine) {
        Alpine.data('systemDashboard', systemDashboard);
    }
});
</script>
{% endblock %}
